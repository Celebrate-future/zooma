var default_zooma_url="http://www.ebi.ac.uk/spot/zooma/",default_zooma_base_path="v2/api/services",default_logging_div="zooma-log",default_ols_url="http://www.ebi.ac.uk/ols/beta/api/ontologies/",default_ols_search_end="terms?short_form=";!function(t){var e,n,o,a,i;t.get("js/zooma.html",function(t){o=t,Mustache.parse(o)});var r={initOptions:function(t,e){var n=s(e);return l(n),c(),u(),n},autocomplete:function(t,e){var n=r.initOptions(t,e);return C(t,n)},annotate:function(t,e){var n=r.initOptions(t,e);return U(t,n)}},s=function(e){var n=t.extend({zooma_url:default_zooma_url,zooma_base_path:default_zooma_base_path},e);return t.extend({zooma_suggest_path:n.zooma_url+n.zooma_base_path+"/suggest",zooma_annotate_path:n.zooma_url+n.zooma_base_path+"/annotate",logging:"none",loggingDiv:default_logging_div},n)},c=function(){a=t("<span>").attr("id","zooma-spinner").append(t("<div>").addClass("throbber-loader")).hide()},u=function(){i=t("<span>").attr("id","zooma-spinner").append(t("<div>").addClass("throbber-loader"))},l=function(o){if("console"!=o.logging&&"div"!=o.logging&&"none"!=o.logging)throw"logging option must be one of 'console', 'div' or 'none'";e=o.logging,"div"==e&&(n=t("#"+o.loggingDiv))},d=function(o){if("console"==e)try{console.log(o)}catch(a){console.log("Failed to log ("+a+")")}if("div"==e)try{0===n.length&&(t("body").append('<div id="zooma-log" />'),t("#zooma-log").hide()),n.append('<div class="logmessage">'+o+"</div>")}catch(a){n.append("Failed to log ("+a+")")}},p=function(t,e){switch(e=e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()){case"Array":case"Function":case"Object":case"String":case"Number":case"Date":break;default:return!1}var n={},o="[object "+e+"]";return t&&n.toString.call(t)===o},f=function(t){var e={};return t&&"[object Function]"===e.toString.call(t)},h=function(t){return p(t,"Array")},g=function(t){return p(t,"String")},m=function(e){try{var n=t(e);return d(e+" is a valid jQuery selector (selects "+n+")"),!0}catch(o){return d(o),!1}},v=function(t,e){return t.bind("keypress",function(t){13==t.keyCode&&e.apply(this,[t])})},_=function(t,e){t.attr("id",e)},b=function(t,e){function n(t,e){return t.length>e?t.slice(0,e)+"...":t}var o=t;if("undefined"!=typeof t&&null!==t)if(("undefined"==typeof e||null===e)&&(e=300),h(t))for(var a=0;a<t.length;a++)o.push(n(t[a],e));else g(t)&&(o=n(t,e));return o},z=function(t){var e=t.match(/([A-Z]+)_\d+/);return e&&e.length>1?e[1].toLowerCase():"efo"},y=function(e,n){var a=z(n.shortname),i=default_ols_url+a+"/"+default_ols_search_end+n.shortname;e.tooltipster({content:"Loading...",contentAsHTML:!0,interactive:!0,maxWidth:400,trigger:"hover",theme:"tooltipster-light",functionBefore:function(e,a){a(),"cached"!==e.data("ajax")&&t.ajax({type:"GET",url:i,success:function(t){var a=t._embedded.terms[0],i={};i.term=a.label,i.confidence=n.confidence,i.description=a.description,i.iri=a.iri,i.isUserTerm="USER"===n.confidence,i.lower=function(){return function(t,e){return e(t).toLowerCase()}},i.excerpt=function(){return function(t,e){return b(e(t),400)+"</p>"}};var r=Mustache.render(o,i);e.tooltipster("content",r).data("ajax","cached")},error:function(t){"USER"===n.confidence?e.tooltipster("content","No informations for this custom term").data("ajax","cached"):e.tooltipster("content","Error retrieving content").data("ajax","cached")}})}})},w=function(e){var n=t(".bootstrap-tagsinput"),o=t("#zooma-separated-suggestions");e.on("itemAdded",function(e){var a=e.item.shortname,i=n.find("span.tag:contains('"+a+"')"),r=o.find("option[value="+a+"]");i.on("click",function(e){o.children("option").each(function(e,n){t(n).removeAttr("selected")}),n.children(".tag").removeClass("selected"),i.toggleClass("selected"),r.val("selected","selected")}),_(i,a),y(i,e.item)})},k=function(e,n){d("Adding user custom term "+n+" to term list");var o={};o.shortname=n,o.confidence="USER";var a=t("[data-role=tagsinput]");a.tagsinput("add",o)},j=function(){return t("<button class='btn-custom-term'>Use custom term</button>")},x=function(t){var e=t.find("input");v(e,function(){k(t,e.val())})},A=function(t,e,n){d("Retrieving zooma suggested terms for "+n),e.siblings(".zooma-annotations-container").show(),e.tagsinput("removeAll"),a.show(),jQuery.getJSON(t.zooma_annotate_path+"?propertyValue="+encodeURI(n),function(t){S(e,t)})},S=function(e,n){a.hide(),e.tagsinput("removeAll"),t(n).each(function(n,o){var a=[];if(t(o.semanticTags).each(function(t,e){var n=e.split("/"),o=n[n.length-1].split("#"),i=o[o.length-1];a.push(i)}),a.length>1){for(var i="",r=0;r<a.length-1;r++)i=i+a[r]+" & ";i+=a[length-1],o.shortname=i}else a.length>0?o.shortname=a[0]:o.shortname="Unknown";e.tagsinput("add",o)})},C=function(e,n){d("Adding zooma autocomplete functionality to "+e.attr("id")+" with configuration: "+JSON.stringify(n));var o=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:n.zooma_suggest_path+"?prefix=%QUERY",wildcard:"%QUERY"}});d("Binding typeahead to "+e.attr("id")+"..."),e.typeahead({hint:!0,highlight:!0,minLength:3},{source:o}),d("Typeahead bound ok!");var a=t('<div class="zooma-autocomplete-container"></div>');return e.parent().wrap(a),a},U=function(e,n){d("Adding zooma annotation functionality to "+e.attr("id")+" with configuration: "+JSON.stringify(n)),e.attr("data-role","tagsinput"),e.tagsinput({trimValue:!0,itemValue:"shortname",itemText:"shortname",freeInput:!0,confirmKeys:[13],tagClass:function(t){var e=["tooltip","label"];switch(t.confidence){case"HIGH":e.push("high-confidence-label");break;case"GOOD":e.push("good-confidence-label");break;case"MEDIUM":e.push("medium-confidence-label");break;case"LOW":e.push("low-confidence-label");break;case"USER":e.push("user-confidence-label");break;default:e.push("default-label")}return e.join(" ")}}),w(e);var o=t(".bootstrap-tagsinput");x(o),d("Setup tagsinput on "+e.attr("id")+" ok!");var i,r=n.annotation_source;f(r)?(i=r.apply(this,[]),A(n,e,i)):r.is("input")?v(t(r),function(){d("Detected enter pressed on "+r.attr("id"));var t=r.val();A(n,e,t)}):m(r)?A(n,e,t(r)):A(n,e,r),d("Annotation detection bound ok!");var s=e.parent().children(".bootstrap-tagsinput");s.addClass("zooma-annotations-container");var c=s.find("input").attr("id","custom-term-input");c.keypress(function(t){switch(t.which){case 13:c.val(""),c.hide()}}).keyup(function(t){switch(t.which){case 27:c.val(""),c.hide()}}),c.hide(),a.prependTo(s);var u=j();return u.appendTo(s),u.on("click",function(t){c.show()}),s.hide(),s},O=function(e,n){var o=s(n);l(o),d("Attempting to set up unified zooma widget from "+e.attr("id")+"...");var a,i;if(e.is("input")){a=t('<select class="zooma-tags" multiple style="display: none"></select>'),e.after(a);var r=C(e,o);i=t.extend({annotation_source:e},o),U(a,i);var c=t('<div class="zooma-container"></div>');return r.wrap(c),c}if(e.is("div")){e.append("Search:");var u=t('<input type="text" class="zooma-input" />');return e.append(u),a=t('<select class="zooma-tags" multiple style="display: none"></select>'),e.append(a),C(u,o),i=t.extend({annotation_source:u},o),U(a,i),e.addClass("zooma-container"),e}throw"Zooma target must be either <input> or <div> element"};t.fn.zooma=function(e,n){if(r[e])return this.each(function(){return r[e].apply(this,[t(this),n])});try{return O(t(this),e)}catch(o){t.error("Invalid usage: jQuery.zooma plugin does not support the command '"+e+"' and this is not an options object either")}}}(jQuery);