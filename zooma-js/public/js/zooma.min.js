var default_zooma_url="http://www.ebi.ac.uk/spot/zooma/",default_zooma_base_path="v2/api/services",default_logging_div="zooma-log",default_ols_url="http://www.ebi.ac.uk/ols/beta/api/ontologies/",default_ols_search_end="terms?short_form=";!function(t,e){var n,o,a,i,r;t.get("js/zooma.html",function(t){a=t,e.parse(a)});var s={initOptions:function(t,e){var n=c(e);return d(n),u(),l(),n},autocomplete:function(t,e){var n=s.initOptions(t,e);return U(t,n)},annotate:function(t,e){var n=s.initOptions(t,e);return O(t,n)}},c=function(e){var n=t.extend({zooma_url:default_zooma_url,zooma_base_path:default_zooma_base_path},e);return t.extend({zooma_suggest_path:n.zooma_url+n.zooma_base_path+"/suggest",zooma_annotate_path:n.zooma_url+n.zooma_base_path+"/annotate",logging:"none",loggingDiv:default_logging_div},n)},u=function(){i=t("<span>").attr("id","zooma-spinner").append(t("<div>").addClass("throbber-loader")).hide()},l=function(){r=t("<span>").attr("id","zooma-spinner").append(t("<div>").addClass("throbber-loader"))},d=function(e){if("console"!=e.logging&&"div"!=e.logging&&"none"!=e.logging)throw"logging option must be one of 'console', 'div' or 'none'";n=e.logging,"div"==n&&(o=t("#"+e.loggingDiv))},p=function(e){if("console"==n)try{console.log(e)}catch(a){console.log("Failed to log ("+a+")")}if("div"==n)try{0===o.length&&(t("body").append('<div id="zooma-log" />'),t("#zooma-log").hide()),o.append('<div class="logmessage">'+e+"</div>")}catch(a){o.append("Failed to log ("+a+")")}},f=function(t,e){switch(e=e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()){case"Array":case"Function":case"Object":case"String":case"Number":case"Date":break;default:return!1}var n={},o="[object "+e+"]";return t&&n.toString.call(t)===o},h=function(t){var e={};return t&&"[object Function]"===e.toString.call(t)},g=function(t){return f(t,"Array")},m=function(t){return f(t,"String")},v=function(e){try{var n=t(e);return p(e+" is a valid jQuery selector (selects "+n+")"),!0}catch(o){return p(o),!1}},_=function(t,e){return t.bind("keypress",function(t){13==t.keyCode&&e.apply(this,[t])})},b=function(t,e){t.attr("id",e)},z=function(t,e){function n(t,e){return t.length>e?t.slice(0,e)+"...":t}var o=t;if("undefined"!=typeof t&&null!==t)if(("undefined"==typeof e||null===e)&&(e=300),g(t))for(var a=0;a<t.length;a++)o.push(n(t[a],e));else m(t)&&(o=n(t,e));return o},y=function(t){var e=t.match(/([A-Z]+)_\d+/);return e&&e.length>1?e[1].toLowerCase():"efo"},w=function(n,o){var i=y(o.shortname),r=default_ols_url+i+"/"+default_ols_search_end+o.shortname;n.tooltipster({content:"Loading...",contentAsHTML:!0,interactive:!0,maxWidth:400,trigger:"hover",theme:"tooltipster-light",functionBefore:function(n,i){i(),"cached"!==n.data("ajax")&&t.ajax({type:"GET",url:r,success:function(t){var i=t._embedded.terms[0],r={};r.term=i.label,r.confidence=o.confidence,r.description=i.description,r.iri=i.iri,r.isUserTerm="USER"===o.confidence,r.lower=function(){return function(t,e){return e(t).toLowerCase()}},r.excerpt=function(){return function(t,e){return z(e(t),400)+"</p>"}};var s=e.render(a,r);n.tooltipster("content",s).data("ajax","cached")},error:function(t){"USER"===o.confidence?n.tooltipster("content","No informations for this custom term").data("ajax","cached"):n.tooltipster("content","Error retrieving content").data("ajax","cached")}})}})},k=function(e){var n=t(".bootstrap-tagsinput"),o=t("#zooma-separated-suggestions");e.on("itemAdded",function(e){var a=e.item.shortname,i=n.find("span.tag:contains('"+a+"')"),r=o.find("option[value="+a+"]");i.on("click",function(e){o.children("option").each(function(e,n){t(n).removeAttr("selected")}),n.children(".tag").removeClass("selected"),i.toggleClass("selected"),r.val("selected","selected")}),b(i,a),w(i,e.item)})},j=function(e,n){p("Adding user custom term "+n+" to term list");var o={};o.shortname=n,o.confidence="USER";var a=t("[data-role=tagsinput]");a.tagsinput("add",o)},x=function(){return t("<button class='btn-custom-term'>Use custom term</button>")},A=function(t){var e=t.find("input");_(e,function(){j(t,e.val())})},S=function(t,e,n){p("Retrieving zooma suggested terms for "+n),e.siblings(".zooma-annotations-container").show(),e.tagsinput("removeAll"),i.show(),jQuery.getJSON(t.zooma_annotate_path+"?propertyValue="+encodeURI(n),function(t){C(e,t)})},C=function(e,n){i.hide(),e.tagsinput("removeAll"),t(n).each(function(n,o){var a=[];if(t(o.semanticTags).each(function(t,e){var n=e.split("/"),o=n[n.length-1].split("#"),i=o[o.length-1];a.push(i)}),a.length>1){for(var i="",r=0;r<a.length-1;r++)i=i+a[r]+" & ";i+=a[length-1],o.shortname=i}else a.length>0?o.shortname=a[0]:o.shortname="Unknown";e.tagsinput("add",o)})},U=function(e,n){p("Adding zooma autocomplete functionality to "+e.attr("id")+" with configuration: "+JSON.stringify(n));var o=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:n.zooma_suggest_path+"?prefix=%QUERY",wildcard:"%QUERY"}});p("Binding typeahead to "+e.attr("id")+"..."),e.typeahead({hint:!0,highlight:!0,minLength:3},{source:o}),p("Typeahead bound ok!");var a=t('<div class="zooma-autocomplete-container"></div>');return e.parent().wrap(a),a},O=function(e,n){p("Adding zooma annotation functionality to "+e.attr("id")+" with configuration: "+JSON.stringify(n)),e.attr("data-role","tagsinput"),e.tagsinput({trimValue:!0,itemValue:"shortname",itemText:"shortname",freeInput:!0,confirmKeys:[13],tagClass:function(t){var e=["tooltip","label"];switch(t.confidence){case"HIGH":e.push("high-confidence-label");break;case"GOOD":e.push("good-confidence-label");break;case"MEDIUM":e.push("medium-confidence-label");break;case"LOW":e.push("low-confidence-label");break;case"USER":e.push("user-confidence-label");break;default:e.push("default-label")}return e.join(" ")}}),k(e);var o=t(".bootstrap-tagsinput");A(o),p("Setup tagsinput on "+e.attr("id")+" ok!");var a,r=n.annotation_source;h(r)?(a=r.apply(this,[]),S(n,e,a)):r.is("input")?_(t(r),function(){p("Detected enter pressed on "+r.attr("id"));var t=r.val();S(n,e,t)}):v(r)?S(n,e,t(r)):S(n,e,r),p("Annotation detection bound ok!");var s=e.parent().children(".bootstrap-tagsinput");s.addClass("zooma-annotations-container");var c=s.find("input").attr("id","custom-term-input");c.keypress(function(t){switch(t.which){case 13:c.val(""),c.hide()}}).keyup(function(t){switch(t.which){case 27:c.val(""),c.hide()}}),c.hide(),i.prependTo(s);var u=x();return u.appendTo(s),u.on("click",function(t){c.show()}),s.hide(),s},T=function(e,n){var o=c(n);d(o),p("Attempting to set up unified zooma widget from "+e.attr("id")+"...");var a,i;if(e.is("input")){a=t('<select class="zooma-tags" multiple style="display: none"></select>'),e.after(a);var r=U(e,o);i=t.extend({annotation_source:e},o),O(a,i);var s=t('<div class="zooma-container"></div>');return r.wrap(s),s}if(e.is("div")){e.append("Search:");var u=t('<input type="text" class="zooma-input" />');return e.append(u),a=t('<select class="zooma-tags" multiple style="display: none"></select>'),e.append(a),U(u,o),i=t.extend({annotation_source:u},o),O(a,i),e.addClass("zooma-container"),e}throw"Zooma target must be either <input> or <div> element"};t.fn.zooma=function(e,n){if(s[e])return this.each(function(){return s[e].apply(this,[t(this),n])});try{return T(t(this),e)}catch(o){t.error("Invalid usage: jQuery.zooma plugin does not support the command '"+e+"' and this is not an options object either")}}}(jQuery,Mustache);